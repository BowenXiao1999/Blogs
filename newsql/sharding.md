#! https://zhuanlan.zhihu.com/p/194308853
# 分布式数据库分片 (一)

本文的定位是记录我本人的一些思考，思维比较跳跃。



先探讨一个问题，我们为什么需要分布式数据库？

这个问题很多人都可以给你说一大堆理由。个人认为大部分原因可以总结为２个字：分片（当然还有高可用方面的考量）。本来传统的单机数据库刚出来的时候，企业用着觉得还ok。后来数据量越来越大，单机性能瓶颈已经达到了，这是最大的痛点，那怎么办呢？分片。为什么分片能提升效率？因为分片就像小组作业里的分工一样，一个数据库只负责原来部分数据的读写，自然写入和读取的性能快很多。不过这也引入了很多问题，比如分布式事务怎么做？以前的数据都在一台实例上，事务比较好实现，现在分布式化了，分布式事务的实现成本一定是高于单机事务的，这也是很多NoSQL直接不支持事务的原因。这些本文暂不讨论。

好，既然分片可以解决痛点，那分片怎么做？PGXC做分片，受限于历史原因，分片一般是Hash分片或者Range静态分片。这种带来了很不好的体验，我读过PingCAP CTO 黄东旭的早年的一些资料，他说过当初做TiDB的很大一个原因就是手动维护MySQL的分片是一个很不好的体验（"这件事情那么屎"）。尤其是互联网业务，根本不适合静态分片和Hash分片这种太固定死板的分片方式。试想一下如果真的有业务是所有数据表同一热度的话，确实静态分片没什么大问题，但是事实不是如此。于是Range-based的动态分片被提出，它也成为检验NewSQL的一个标准，实现自动化的负载均衡，分片管理。这个动态管理的特性非常符合互联网数据访问的特点，自然成为了主流，而且也解放了不少人力物力。

那是不是Hash分片就没有存在的价值呢？我查了一些资料，它在并发写入的场景下是比较不错的。因为不同row的位置一般都在不同的主机上，这时候可以并行利用多台主机的I/O能力。而同一个Range可能只能单线程处理（？这里不确定实现，属于自己推测）。但是在查询场景下，由于Hash的离散性，它带来的效率上的提升就被稀释了，这种情况Range更强。

我最近看Aurora的论文的时候，也注意到了它的分片方式。它同样采用了动态调度的Range分片。Aurora的手术切口是在MySQL的存储层，大幅度增强的存储能力，很有可能也跟分片的方式有关。所以从某种程度上来看，Aurora的设计思路大概也是改进分片，但是似乎这一点没有在论文大书特书，反而是log is the database最响亮。本来Aurora的设计思路应该是挺像PGXC，但是不同的是它没有代理层做sharding，而是把sharding做在了存储层，这个思路很不错。

总结一下就是，分布式数据库很大程度上的一个设计驱动力就是数据的分片（当然还有云计算时代对高可用和crash safe能力的高要求，逃）。