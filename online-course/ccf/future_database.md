# CCF走进校园

对数据库未来研究趋势的一个总结。

很多人觉得数据库发展这么久，理论如此成熟，科研里面可以做的东西少了。其实不然，在当下数据越来越爆炸的时代，挑战与机会是并存的。

先回顾一下数据库的架构。从单体数据库，到主备来做高可用，再到Oracle RAC的多活，再到完全分布式架构的数据库。RAC这种类型支持了多活，但是却在存储容量上受限，并且有一个很重要的问题(cache一致性)。cache一致性是指，更新操作一般是WAL+内存来避免同步随机写，那这样一来就带来一个问题，A可能把更新数据存在内存里了，还没来得及写入磁盘，但是B这时候收到一个读相关数据的请求，要怎么样保证能读到最新的数据？

分布式数据库讲究shard，并且同样是多活。但是这带来很多问题，比如事务模型怎么做，查询优化怎么做。

## 分布式数据库的挑战

### 分片
分布式数据库，一个很重要的关键点就是数据怎么分的问题。行存还是列存？这个比较好选择。但是同样有更多问题等着研究。比如

如何保证你选的partition key在数据增长的时候依然保持均匀分布？
是不是应该在Query的比较多的列上做Partition？
Join的比较频繁的2个Region，是不是一般放到一起比较好？

这里有人在SIGMOD上用学习的办法去学partition应该怎么做。同样还有Graph Partition。

以及还有一个关键点，partiton完了之后怎么Evaluate？因为很有可能可以分片的方案非常多，不可能做到每一种新的Partition都完整跑Query来评测。因此有没有一种模型Evaluate Model，我给出一个分片方案，就能评估方案的表现？

### 事务
分布式的事务支持，是Newsql和分库分表方案的关键点。有很多业务至今没有使用Newsql，就是因为它们的事务模型比较简单，分库分表就能解决。因此，这个模块怎么设计也是一大难题。

业界普遍使用的比较多的模型是2PC。但是2PC有很多种实现方式，比如各种优化。事务模型涉及到的概念比较多，比如怎么做并发控制，怎么控制写写冲突（一般通过锁），读写冲突（MVCC）。同时，数据库要支持哪些隔离级别也非常影响相关的设计。比较传统的方案，应该是通过统一发号器，每次查询前/事务开始前拿到一致性视图。PG在2013年的论文，提出了新的隔离级别SSI，并且应用在系统中，使用的是图检测的方式。

分布式事务纷繁复杂，但是这里我主要讲发号器。它是整个事务的灵魂数据。一个准确，HA的发号器对于事务是非常有用的，无论是判断数据可见性，一致性，化解数据冲突等等。而分布式架构带来新的难点，因为每台机器时间不一样，会有time drift的现象】。因此这鼓励学术界提出更好的发号器。后来出现了逻辑时钟，HLC，True Time。HLC既能通过逻辑时钟部分的设计来减少对中心化授时的需求，也能对所有的时间戳进行排序，成为大部分分布式系统设计的首选。True Time是从硬件层面做到误差控制。通过】GPS校验来做误差校准。

### 优化
我一直觉得优化器是整个数据库工程难度最大的部分之一。在分布式架构下，这种查询优化变得更加难了，分布式查询器有了无限的改进空间。因为分布式了，那么传统单机的分析方法很可能不准确了－－不同节点数据交互要考虑网络因素，A,B上２个表要join，是A传给B好呢，还是B传给A好？越复杂的分析，网络交互就越多，也越难以分析。

### 高可用
数据库做高可用主要有这么几种办法：
1. 硬件冗余（多台机器，比如主备）
2. 软件冗余（多副本，两地三中心，异地多活，数据复制）
3. 自动诊断，预测（用机器学习的办法来监控数据库应用的情况）



